"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var React = require("react");
var utils_1 = require("./utils");
/**
 * This hook returns context selected value by selector.
 * It will only accept context created by `createContext`.
 * It will trigger re-render if only the selected value is referencially changed.
 */
exports.useContextSelector = function (context, selector) {
    var _a = React.useContext(context), subscribe = _a.subscribe, value = _a.value;
    var _b = React.useReducer(function (c) { return c + 1; }, 0), forceUpdate = _b[1];
    var ref = React.useRef();
    var selected = selector(value);
    utils_1.useIsomorphicLayoutEffect(function () {
        ref.current = {
            selector: selector,
            value: value,
            selected: selected,
        };
    });
    utils_1.useIsomorphicLayoutEffect(function () {
        var callback = function (nextState) {
            try {
                var reference = ref.current;
                if (reference.value === nextState || Object.is(reference.selected, reference.selector(nextState))) {
                    // not changed
                    return;
                }
            }
            catch (e) {
                // ignored (stale props or some other reason)
            }
            forceUpdate();
        };
        return subscribe(callback);
    }, [subscribe]);
    return selected;
};
