import { SPHttpClient } from '@microsoft/sp-http';
import { Environment, EnvironmentType } from '@microsoft/sp-core-library';
import SPPeoplePickerMockHttpClient from './SPPeopleSearchMockService';
/**
 * Service implementation to search sites in SharePoint
 */
var SPSiteSearchService = /** @class */ (function () {
    function SPSiteSearchService() {
    }
    /**
     * Search sites from the SharePoint
     */
    SPSiteSearchService.prototype.searchSites = function (ctx, query) {
        if (Environment.type === EnvironmentType.Local) {
            // If the running environment is local, load the data from the mock
            return this.searchSitesFromMock(ctx, query);
        }
        else {
            var rootUrl = ctx.pageContext.web.absoluteUrl;
            if (ctx.pageContext.web.serverRelativeUrl !== "/") {
                rootUrl = ctx.pageContext.web.absoluteUrl.replace(ctx.pageContext.web.serverRelativeUrl, '');
            }
            // If the running env is SharePoint, loads from the search
            var userRequestUrl = ctx.pageContext.web.absoluteUrl + "/_api/search/query?querytext='contentclass:STS_Site contentclass:STS_Web Title:*" + query + "* Path:" + rootUrl + "*'&selectproperties='SiteId,Title,Path'&rowlimit=5";
            // Do the call against the SP REST API search endpoint
            return ctx.spHttpClient.get(userRequestUrl, SPHttpClient.configurations.v1).then(function (searchResponse) {
                return searchResponse.json().then(function (sitesResponse) {
                    var res = [];
                    var values = sitesResponse.PrimaryQueryResult.RelevantResults.Table.Rows;
                    res = values.map(function (element) {
                        var site = {};
                        element.Cells.forEach(function (cell) {
                            switch (cell.Key) {
                                case 'Title':
                                    site.title = cell.Value;
                                    break;
                                case 'Path':
                                    site.url = cell.Value;
                                    break;
                                case 'SiteId':
                                    site.id = cell.Value;
                                    break;
                            }
                        });
                        return site;
                    });
                    return res;
                });
            });
        }
    };
    /**
     * Returns fake sites results for the Mock mode
     */
    SPSiteSearchService.prototype.searchSitesFromMock = function (ctx, query) {
        return SPPeoplePickerMockHttpClient.searchPeople(ctx.pageContext.web.absoluteUrl).then(function () {
            var results = [
                { title: 'Contoso Site', id: '611453e1-5b5d-45ec-94aa-a180a02df897', url: ctx.pageContext.web.absoluteUrl }
            ];
            return results;
        });
    };
    return SPSiteSearchService;
}());
export default SPSiteSearchService;
//# sourceMappingURL=SPSiteSearchService.js.map