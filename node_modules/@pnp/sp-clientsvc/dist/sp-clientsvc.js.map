{"version":3,"file":"sp-clientsvc.js","sources":["../../../../packages/sp-clientsvc/src/opactionbuilders.ts","../../../../packages/sp-clientsvc/src/opbuilders.ts","../../../../packages/sp-clientsvc/src/utils.ts","../../../../packages/sp-clientsvc/src/objectpath.ts","../../../../packages/sp-clientsvc/src/parsers.ts","../../../../packages/sp-clientsvc/src/clintsvcqueryable.ts","../../../../packages/sp-clientsvc/src/batch.ts"],"sourcesContent":["import { PropertyType } from \"./types\";\nimport { IMethodParamsBuilder } from \"./opbuilders\";\n\nexport function objectPath(): string {\n    return `<ObjectPath Id=\"$$ID$$\" ObjectPathId=\"$$PATH_ID$$\" />`;\n}\n\nexport function identityQuery(): string {\n    return `<ObjectIdentityQuery Id=\"$$ID$$\" ObjectPathId=\"$$PATH_ID$$\" />`;\n}\n\nexport function opQuery(selectProperties: string[] = null, childSelectProperties: string[] | null = null): string {\n\n    // this is fairly opaque behavior, but is the simplest way to convey the required information.\n    // if selectProperties.length === 0 or null then select all\n    // else select indicated properties\n\n    // if childSelectProperties === null do not include that block\n    // if childSelectProperties.length === 0 then select all\n    // else select indicated properties\n\n    const builder = [];\n    builder.push(`<Query Id=\"$$ID$$\" ObjectPathId=\"$$PATH_ID$$\">`);\n    if (selectProperties === null || selectProperties.length < 1) {\n        builder.push(`<Query SelectAllProperties=\"true\" >`);\n        builder.push(`<Properties />`);\n        builder.push(`</Query >`);\n    } else {\n        builder.push(`<Query SelectAllProperties=\"false\" >`);\n        builder.push(`<Properties>`);\n        [].push.apply(builder, <any>selectProperties.map(p => `<Property Name=\"${p}\" SelectAll=\"true\" />`));\n        builder.push(`</Properties>`);\n        builder.push(`</Query >`);\n    }\n\n    if (childSelectProperties !== null) {\n        if (childSelectProperties.length < 1) {\n            builder.push(`<ChildItemQuery SelectAllProperties=\"true\" >`);\n            builder.push(`<Properties />`);\n            builder.push(`</ChildItemQuery >`);\n        } else {\n            builder.push(`<ChildItemQuery SelectAllProperties=\"false\" >`);\n            builder.push(`<Properties>`);\n            [].push.apply(builder, <any>childSelectProperties.map(p => `<Property Name=\"${p}\" SelectAll=\"true\" />`));\n            builder.push(`</Properties>`);\n            builder.push(`</ChildItemQuery >`);\n        }\n    }\n\n    builder.push(`</Query >`);\n\n    return builder.join(\"\");\n}\n\nexport function setProperty(name: string, type: PropertyType, value: string): string {\n    const builder = [];\n    builder.push(`<SetProperty Id=\"$$ID$$\" ObjectPathId=\"$$PATH_ID$$\" Name=\"${name}\">`);\n    builder.push(`<Parameter Type=\"${type}\">${value}</Parameter>`);\n    builder.push(`</SetProperty>`);\n    return builder.join(\"\");\n}\n\nexport function methodAction(name: string, params: IMethodParamsBuilder | null): string {\n\n    const builder = [];\n    builder.push(`<Method Id=\"$$ID$$\" ObjectPathId=\"$$PATH_ID$$\" Name=\"${name}\">`);\n\n    if (params !== null) {\n        const arrParams = params.toArray();\n        if (arrParams.length < 1) {\n            builder.push(`<Parameters />`);\n        } else {\n            builder.push(`<Parameters>`);\n            [].push.apply(builder, <any>arrParams.map(p => `<Parameter Type=\"${p.type}\">${p.value}</Parameter>`));\n            builder.push(`</Parameters>`);\n        }\n    }\n\n    builder.push(\"</Method>\");\n\n    return builder.join(\"\");\n}\n\nexport function objectProperties(o: any): string[] {\n\n    return Object.getOwnPropertyNames(o).map((name) => {\n\n        const value = o[name];\n        if (typeof value === \"boolean\") {\n            return setProperty(name, \"Boolean\", `${value}`);\n        } else if (typeof value === \"number\") {\n            return setProperty(name, \"Number\", `${value}`);\n        } else if (typeof value === \"string\") {\n            return setProperty(name, \"String\", `${value}`);\n        }\n\n        return \"\";\n    }, []);\n}\n","import { ObjectPath, IObjectPath } from \"./objectpath\";\nimport { PropertyType } from \"./types\";\n\nexport function property(name: string, ...actions: string[]): IObjectPath {\n    return new ObjectPath(`<Property Id=\"$$ID$$\" ParentId=\"$$PARENT_ID$$\" Name=\"${name}\" />`, actions);\n}\n\nexport function staticMethod(name: string, typeId: string, ...actions: string[]): IObjectPath {\n    return new ObjectPath(`<StaticMethod Id=\"$$ID$$\" Name=\"${name}\" TypeId=\"${typeId}\" />`, actions);\n}\n\nexport function staticProperty(name: string, typeId: string, ...actions: string[]): IObjectPath {\n    return new ObjectPath(`<StaticProperty Id=\"$$ID$$\" Name=\"${name}\" TypeId=\"${typeId}\" />`, actions);\n}\n\nexport function objConstructor(typeId: string, ...actions: string[]): IObjectPath {\n    return new ObjectPath(`<Constructor Id=\"$$ID$$\" TypeId=\"${typeId}\" />`, actions);\n}\n\nexport interface IMethodParamsBuilder {\n    string(value: string): this;\n    number(value: number): this;\n    boolean(value: boolean): this;\n    strArray(values: string[]): this;\n    objectPath(inputIndex: number): this;\n    toArray(): { type: PropertyType, value: string }[];\n}\n\n/**\n * Used to build parameters when calling methods\n */\nexport class MethodParams implements IMethodParamsBuilder {\n\n    constructor(private _p: { type: PropertyType, value: string }[] = []) { }\n\n    public static build(initValues: { type: PropertyType, value: string }[] = []): IMethodParamsBuilder {\n        const params = new MethodParams();\n        [].push.apply(params._p, <any>initValues);\n        return params;\n    }\n\n    public string(value: string): this {\n        return this.a(\"String\", value);\n    }\n\n    public number(value: number): this {\n        return this.a(\"Number\", value.toString());\n    }\n\n    public boolean(value: boolean): this {\n        return this.a(\"Boolean\", value.toString());\n    }\n\n    public strArray(values: string[]): this {\n        return this.a(\"Array\", values.map(v => `<Object Type=\"String\">${v}</Object>`).join(\"\"));\n    }\n\n    public objectPath(inputIndex: number): this {\n        return this.a(\"ObjectPath\", inputIndex.toString());\n    }\n\n    public toArray(): { type: PropertyType, value: string }[] {\n        return this._p;\n    }\n\n    private a(type: PropertyType, value: string): this {\n        value = value.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\").replace(/\"/g, \"&quot;\").replace(/'/g, \"&apos;\");\n        this._p.push({ type, value });\n        return this;\n    }\n}\n\nexport function method(name: string, params: IMethodParamsBuilder, ...actions: string[]): IObjectPath {\n    const builder = [];\n    builder.push(`<Method Id=\"$$ID$$\" ParentId=\"$$PARENT_ID$$\" Name=\"${name}\">`);\n\n    if (params !== null) {\n        const arrParams = params.toArray();\n        if (arrParams.length < 1) {\n            builder.push(`<Parameters />`);\n        } else {\n            builder.push(`<Parameters>`);\n            [].push.apply(builder, <any>arrParams.map(p => {\n\n                if (p.type === \"ObjectPath\") {\n                    return `<Parameter ObjectPathId=\"$$OP_PARAM_ID_${p.value}$$\" />`;\n                }\n\n                return `<Parameter Type=\"${p.type}\">${p.value}</Parameter>`;\n            }));\n            builder.push(`</Parameters>`);\n        }\n    }\n\n    builder.push(\"</Method>\");\n\n    return new ObjectPath(builder.join(\"\"), actions);\n}\n","import { IObjectPath } from \"./objectpath\";\n\n/**\n * Transforms an array of object paths into a request xml body. Does not do placeholder substitutions.\n * \n * @param objectPaths The object paths for which we want to generate a body\n */\nexport function writeObjectPathBody(objectPaths: IObjectPath[]): string {\n\n    const actions: string[] = [];\n    const paths: string[] = [];\n\n    objectPaths.forEach(op => {\n        paths.push(op.path);\n        actions.push(...op.actions);\n    });\n\n    // create our xml payload\n    return [\n        `<Request xmlns=\"http://schemas.microsoft.com/sharepoint/clientquery/2009\" SchemaVersion=\"15.0.0.0\" LibraryVersion=\"16.0.0.0\" ApplicationName=\"PnPjs\">`,\n        \"<Actions>\",\n        actions.join(\"\"),\n        \"</Actions>\",\n        \"<ObjectPaths>\",\n        paths.join(\"\"),\n        \"</ObjectPaths>\",\n        \"</Request>\",\n    ].join(\"\");\n}\n","import { TypedHash, extend, objectDefinedNotNull } from \"@pnp/common\";\nimport { objectPath } from \"./opactionbuilders\";\nimport { property, staticProperty } from \"./opbuilders\";\nimport { writeObjectPathBody } from \"./utils\";\n\n/**\n * Defines the properties and method of an ObjectPath\n */\nexport interface IObjectPath {\n    /**\n     * The ObjectPath xml node\n     */\n    path: string;\n    /**\n     * Collection of xml action nodes\n     */\n    actions: string[];\n    /**\n     * The id of this object path, used for processing, not set directly\n     */\n    id: number | undefined;\n}\n\n/**\n * Represents an ObjectPath used when querying ProcessQuery\n */\nexport class ObjectPath implements IObjectPath {\n    constructor(public path: string, public actions: string[] = [], public id = -1, public replaceAfter: IObjectPath[] = []) { }\n}\n\n/**\n * Replaces all found instance of the $$ID$$ placeholder in the supplied xml string\n * \n * @param id New value to be insterted\n * @param xml The existing xml fragment in which the replace should occur\n */\nexport function opSetId(id: string, xml: string): string {\n    return xml.replace(/\\$\\$ID\\$\\$/g, id);\n}\n\n/**\n * Replaces all found instance of the $$PATH_ID$$ placeholder in the supplied xml string\n * \n * @param id New value to be insterted\n * @param xml The existing xml fragment in which the replace should occur\n */\nexport function opSetPathId(id: string, xml: string): string {\n    return xml.replace(/\\$\\$PATH_ID\\$\\$/g, id);\n}\n\n/**\n * Replaces all found instance of the $$PARENT_ID$$ placeholder in the supplied xml string\n * \n * @param id New value to be insterted\n * @param xml The existing xml fragment in which the replace should occur\n */\nexport function opSetParentId(id: string, xml: string): string {\n    return xml.replace(/\\$\\$PARENT_ID\\$\\$/g, id);\n}\n\n/**\n * Replaces all found instance of the $$OP_PARAM_ID$$ placeholder in the supplied xml string\n * \n * @param map A mapping where [index] = replaced_object_path_id\n * @param xml The existing xml fragment in which the replace should occur\n * @param indexMapper Used when creating batches, not meant for direct use external to this library\n */\nexport function opSetPathParamId(map: number[], xml: string, indexMapper: (n: number) => number = (n) => n): string {\n\n    // this approach works because input params must come before the things that need them\n    // meaning the right id will always be in the map\n    const matches = /\\$\\$OP_PARAM_ID_(\\d+)\\$\\$/ig.exec(xml);\n    if (matches !== null) {\n        for (let i = 1; i < matches.length; i++) {\n            const index = parseInt(matches[i], 10);\n            const regex = new RegExp(`\\\\$\\\\$OP_PARAM_ID_${index}\\\\$\\\\$`, \"ig\");\n            xml = xml.replace(regex, map[indexMapper(index)].toString());\n        }\n    }\n\n    return xml;\n}\n\n/**\n * Represents a collection of IObjectPaths\n */\nexport class ObjectPathQueue {\n\n    private _xml: string | null;\n    private _contextIndex = -1;\n    private _siteIndex = -1;\n    private _webIndex = -1;\n\n    constructor(protected _paths: IObjectPath[] = [], protected _relationships: TypedHash<number[]> = {}) { }\n\n    /**\n     * Adds an object path to the queue\n     * \n     * @param op The action to add\n     * @returns The index of the added object path\n     */\n    public add(op: IObjectPath): number {\n\n        this.dirty();\n        this._paths.push(op);\n        return this.lastIndex;\n    }\n\n    public addChildRelationship(parentIndex: number, childIndex: number) {\n        if (objectDefinedNotNull(this._relationships[`_${parentIndex}`])) {\n            this._relationships[`_${parentIndex}`].push(childIndex);\n        } else {\n            this._relationships[`_${parentIndex}`] = [childIndex];\n        }\n    }\n\n    public getChildRelationship(parentIndex: number): number[] {\n        if (objectDefinedNotNull(this._relationships[`_${parentIndex}`])) {\n            return this._relationships[`_${parentIndex}`];\n        } else {\n            return [];\n        }\n    }\n\n    public getChildRelationships(): TypedHash<number[]> {\n        return this._relationships;\n    }\n\n    /**\n     * Appends an action to the supplied IObjectPath, replacing placeholders\n     * \n     * @param op IObjectPath to which the action will be appended\n     * @param action The action to append\n     */\n    public appendAction(op: IObjectPath, action: string): this {\n\n        this.dirty();\n        op.actions.push(action);\n        return this;\n    }\n\n    /**\n     * Appends an action to the last IObjectPath in the collection\n     * \n     * @param action \n     */\n    public appendActionToLast(action: string): this {\n\n        return this.appendAction(this.last, action);\n    }\n\n    /**\n     * Creates a linked copy of this ObjectPathQueue\n     */\n    public copy(): ObjectPathQueue {\n        const copy = new ObjectPathQueue(this.toArray(), extend({}, this._relationships));\n        copy._contextIndex = this._contextIndex;\n        copy._siteIndex = this._siteIndex;\n        copy._webIndex = this._webIndex;\n        return copy;\n    }\n\n    /**\n     * Creates an independent clone of this ObjectPathQueue\n     */\n    public clone(): ObjectPathQueue {\n        const clone = new ObjectPathQueue(this.toArray().map(p => Object.assign({}, p)), extend({}, this._relationships));\n        clone._contextIndex = this._contextIndex;\n        clone._siteIndex = this._siteIndex;\n        clone._webIndex = this._webIndex;\n        return clone;\n    }\n\n    /**\n     * Gets a copy of this instance's paths\n     */\n    public toArray(): IObjectPath[] {\n        return this._paths.slice(0);\n    }\n\n    /**\n     * The last IObjectPath instance added to this collection\n     */\n    public get last(): IObjectPath {\n\n        if (this._paths.length < 1) {\n            return null;\n        }\n\n        return this._paths[this.lastIndex];\n    }\n\n    /**\n     * Index of the last IObjectPath added to the queue\n     */\n    public get lastIndex(): number {\n        return this._paths.length - 1;\n    }\n\n    /**\n     * Gets the index of the current site in the queue\n     */\n    public get siteIndex(): number {\n\n        if (this._siteIndex < 0) {\n\n            // this needs to be here in case we create it\n            const contextIndex = this.contextIndex;\n\n            this._siteIndex = this.add(property(\"Site\",\n                // actions\n                objectPath()));\n\n            this.addChildRelationship(contextIndex, this._siteIndex);\n        }\n\n        return this._siteIndex;\n    }\n\n    /**\n     * Gets the index of the current web in the queue\n     */\n    public get webIndex(): number {\n\n        if (this._webIndex < 0) {\n\n            // this needs to be here in case we create it\n            const contextIndex = this.contextIndex;\n\n            this._webIndex = this.add(property(\"Web\",\n                // actions\n                objectPath()));\n\n            this.addChildRelationship(contextIndex, this._webIndex);\n        }\n\n        return this._webIndex;\n    }\n\n    /**\n     * Gets the index of the Current context in the queue, can be used to establish parent -> child rels\n     */\n    public get contextIndex(): number {\n        if (this._contextIndex < 0) {\n            this._contextIndex = this.add(staticProperty(\"Current\", \"{3747adcd-a3c3-41b9-bfab-4a64dd2f1e0a}\",\n                // actions\n                objectPath()));\n        }\n\n        return this._contextIndex;\n    }\n\n    public toBody(): string {\n\n        if (objectDefinedNotNull(this._xml)) {\n            return this._xml;\n        }\n\n        // create our xml payload\n        this._xml = writeObjectPathBody(this.toIndexedTree());\n\n        return this._xml;\n    }\n\n    /**\n     * Conducts the string replacements for id, parent id, and path id\n     * \n     * @returns The tree with all string replacements made\n     */\n    public toIndexedTree(): IObjectPath[] {\n\n        let builderIndex = -1;\n        let lastOpId = -1;\n        const idIndexMap: number[] = [];\n\n        return this.toArray().map((op, index, arr) => {\n\n            const opId = ++builderIndex;\n\n            // track the array index => opId relationship\n            idIndexMap.push(opId);\n\n            // do path replacements\n            op.path = opSetPathParamId(idIndexMap, opSetId(opId.toString(), op.path));\n\n            if (lastOpId >= 0) {\n                // if we have a parent do the replace\n                op.path = opSetParentId(lastOpId.toString(), op.path);\n            }\n\n            // rewrite actions with placeholders replaced\n            op.actions = op.actions.map(a => {\n                const actionId = ++builderIndex;\n                return opSetId(actionId.toString(), opSetPathId(opId.toString(), a));\n            });\n\n            // handle any specific child relationships\n            this.getChildRelationship(index).forEach(childIndex => {\n                // set the parent id for our non-immediate children, thus removing the token so it isn't overwritten\n                arr[childIndex].path = opSetParentId(opId.toString(), arr[childIndex].path);\n            });\n\n            // and remember our last object path id for the parent replace above\n            lastOpId = opId;\n\n            return op;\n        });\n    }\n\n    /**\n     * Dirties this queue clearing any cached data\n     */\n    protected dirty(): void {\n        this._xml = null;\n    }\n}\n","import { getAttrValueFromString, jsS, hOP } from \"@pnp/common\";\nimport { IObjectPath } from \"./objectpath\";\n\n/**\n * Used within the request pipeline to parse ProcessQuery results\n */\nexport class ProcessQueryParser<T = any> {\n\n    constructor(protected op: IObjectPath) { }\n\n    /**\n     * Parses the response checking for errors\n     * \n     * @param r Response object\n     */\n    public parse(r: Response): Promise<T> {\n\n        return r.text().then(t => {\n\n            if (!r.ok) {\n                throw Error(t);\n            }\n\n            try {\n                return JSON.parse(t);\n            } catch (e) {\n                // special case in ProcessQuery where we got an error back, but it is not in json format\n                throw Error(t);\n            }\n\n        }).then((parsed: any[]) => {\n\n            // here we need to check for an error body\n            if (parsed.length > 0 && hOP(parsed[0], \"ErrorInfo\") && parsed[0].ErrorInfo !== null) {\n                throw Error(jsS(parsed[0].ErrorInfo));\n            }\n\n            return this.findResult(parsed);\n        });\n    }\n\n    public findResult(json: any): Promise<T | null> {\n\n        for (let i = 0; i < this.op.actions.length; i++) {\n\n            const a = this.op.actions[i];\n\n            // let's see if the result is null based on the ObjectPath action, if it exists\n            // <ObjectPath Id=\"8\" ObjectPathId=\"7\" />\n            if (/^<ObjectPath /i.test(a)) {\n                const result = this.getParsedResultById<{ IsNull: boolean }>(json, parseInt(getAttrValueFromString(a, \"Id\"), 10));\n                if (!result || (result && result.IsNull)) {\n                    return Promise.resolve(null);\n                }\n            }\n\n            // let's see if we have a query result\n            // <Query Id=\"5\" ObjectPathId = \"3\" >\n            if (/^<Query /i.test(a)) {\n                const result = this.getParsedResultById(json, parseInt(getAttrValueFromString(a, \"Id\"), 10));\n\n                if (result && hOP(result, \"_Child_Items_\")) {\n                    // this is a collection result\n                    /* tslint:disable:no-string-literal */\n                    return Promise.resolve(result[\"_Child_Items_\"]);\n                    /* tslint:enable:no-string-literal */\n                } else {\n                    // this is an instance result\n                    return Promise.resolve(result);\n                }\n            }\n\n            // this is an invokeMethodAction so the last method action corresponds to our result\n            if (i === (this.op.actions.length - 1) && /^<Method /i.test(a)) {\n                return Promise.resolve(this.getParsedResultById(json, parseInt(getAttrValueFromString(a, \"Id\"), 10)));\n            }\n        }\n\n        // no result could be found so we are effectively returning void\n        // issue is we really don't know if we should be returning void (a method invocation with a void return) or\n        // if we just didn't find something above. We will let downstream things worry about that\n    }\n\n    /**\n     * Locates a result by ObjectPath id\n     * \n     * @param parsed the parsed JSON body from the response\n     * @param id The ObjectPath id whose result we want\n     */\n    protected getParsedResultById<R = any>(parsed: any[], id: number): R {\n\n        for (let i = 0; i < parsed.length; i++) {\n\n            if (parsed[i] === id) {\n                return parsed[i + 1];\n            }\n        }\n\n        return null;\n    }\n}\n","import {\n    FetchOptions,\n    combine,\n    extend,\n    getGUID,\n    mergeHeaders,\n    mergeOptions,\n    objectDefinedNotNull,\n    hOP,\n    getHashCode,\n    stringIsNullOrEmpty,\n} from \"@pnp/common\";\nimport { CachingOptions, ICachingOptions, ODataParser, Queryable, RequestContext } from \"@pnp/odata\";\nimport { SPHttpClient, toAbsoluteUrl } from \"@pnp/sp\";\nimport { IObjectPathBatch } from \"./batch\";\nimport { ObjectPathQueue } from \"./objectpath\";\nimport { methodAction, objectPath, objectProperties, opQuery } from \"./opactionbuilders\";\nimport { IMethodParamsBuilder, method, property } from \"./opbuilders\";\nimport { ProcessQueryParser } from \"./parsers\";\n\nexport interface IClientSvcQueryable {\n    select(...selects: string[]): this;\n    usingCaching(options?: ICachingOptions): this;\n    inBatch(batch: IObjectPathBatch): this;\n}\n\nexport interface ClientSvcQueryableConstructor<T> {\n    new(baseUrl: string | ClientSvcQueryable, objectPaths?: ObjectPathQueue): T;\n}\n\nconst ProcessQueryPath = \"_vti_bin/client.svc/ProcessQuery\";\n\nexport class ClientSvcQueryable<GetType = any> extends Queryable<GetType> implements IClientSvcQueryable {\n\n    /**\n     * Collection of select fields\n     */\n    protected _selects: string[];\n\n    /**\n     * Tracks the batch of which this query may be part\n     */\n    protected _batch: IObjectPathBatch | null;\n\n    /**\n     * Allows us to properly block batch execution until everything is loaded\n     */\n    protected _batchDependency: () => void | null;\n\n    constructor(parent: ClientSvcQueryable | string = \"\", protected _objectPaths: ObjectPathQueue | null = null) {\n        super();\n\n        this._selects = [];\n        this._batch = null;\n        this._batchDependency = null;\n\n        if (typeof parent === \"string\") {\n\n            // we assume the parent here is an absolute url to a web\n            this._parentUrl = parent;\n            this._url = combine(parent.replace(ProcessQueryPath, \"\"), ProcessQueryPath);\n            if (!objectDefinedNotNull(this._objectPaths)) {\n                this._objectPaths = new ObjectPathQueue();\n            }\n\n        } else {\n            this._parentUrl = parent._parentUrl;\n            this._url = combine(parent._parentUrl, ProcessQueryPath);\n            if (!objectDefinedNotNull(_objectPaths)) {\n                this._objectPaths = parent._objectPaths.clone();\n            }\n            this.configureFrom(parent);\n        }\n    }\n\n    /**\n     * Choose which fields to return\n     *\n     * @param selects One or more fields to return\n     */\n    public select(...selects: string[]): this {\n        [].push.apply(this._selects, <any>selects);\n        return this;\n    }\n\n    /**\n     * Adds this query to the supplied batch\n     *\n     */\n    public inBatch(batch: IObjectPathBatch): this {\n\n        if (this.batch !== null) {\n            throw Error(\"This query is already part of a batch.\");\n        }\n\n        if (objectDefinedNotNull(batch)) {\n            this._batch = batch;\n            this._batchDependency = batch.addDependency();\n        }\n\n        return this;\n    }\n\n    /**\n     * Gets the full url with query information\n     *\n     */\n    public toUrlAndQuery(): string {\n        return `${super.toUrl()}?${Array.from(this.query).map((v: [string, string]) => v[0] + \"=\" + v[1]).join(\"&\")}`;\n    }\n\n    protected getSelects(): string[] {\n        return objectDefinedNotNull(this._selects) ? this._selects : [];\n    }\n\n    /**\n     * Gets a child object based on this instance's paths and the supplied paramters\n     * \n     * @param factory Instance factory of the child type\n     * @param methodName Name of the method used to load the child\n     * @param params Parameters required by the method to load the child\n     */\n    protected getChild<T>(factory: ClientSvcQueryableConstructor<T>, methodName: string, params: IMethodParamsBuilder | null): T {\n\n        const objectPaths = this._objectPaths.copy();\n\n        objectPaths.add(method(methodName, params,\n            // actions\n            objectPath()));\n\n        return new factory(this, objectPaths);\n    }\n\n    /**\n     * Gets a property of the current instance\n     * \n     * @param factory Instance factory of the child type\n     * @param propertyName Name of the property to load\n     */\n    protected getChildProperty<T>(factory: ClientSvcQueryableConstructor<T>, propertyName: string): T {\n\n        const objectPaths = this._objectPaths.copy();\n\n        objectPaths.add(property(propertyName));\n\n        return new factory(this, objectPaths);\n    }\n\n    /**\n     * Sends a request\n     * \n     * @param op \n     * @param options \n     * @param parser \n     */\n    protected send<T = any>(objectPaths: ObjectPathQueue, options: FetchOptions = {}, parser: ODataParser<T> = null): Promise<T> {\n\n        // here we need to create a clone because all the string indexes and references\n        // will be updated and all need to relate for this operation being sent. The parser\n        // and the postCore method need to share an independent value of the objectPaths\n        // See for https://github.com/pnp/pnpjs/issues/419 for details\n        const clonedOps = objectPaths.clone();\n\n        if (!objectDefinedNotNull(parser)) {\n            // we assume here that we want to return for this index path\n            parser = new ProcessQueryParser(clonedOps.last);\n        }\n\n        if (this.hasBatch) {\n\n            // this is using the options variable to pass some extra information downstream to the batch\n            options = extend(options, {\n                clientsvc_ObjectPaths: clonedOps,\n            });\n\n        } else {\n\n            if (!hOP(options, \"body\")) {\n                options = extend(options, {\n                    body: clonedOps.toBody(),\n                });\n            }\n        }\n\n        return super.postCore(options, parser);\n    }\n\n    /**\n     * Sends the request, merging the result data with a new instance of factory\n     */\n    protected sendGet<DataType, FactoryType>(factory: ClientSvcQueryableConstructor<FactoryType>): Promise<(DataType & FactoryType)> {\n\n        const ops = this._objectPaths.copy().appendActionToLast(opQuery(this.getSelects()));\n\n        return this.send<DataType>(ops).then(r => extend(new factory(this), r));\n    }\n\n    /**\n     * Sends the request, merging the result data array with a new instances of factory\n     */\n    protected sendGetCollection<DataType, FactoryType>(factory: (d: DataType) => FactoryType): Promise<(DataType & FactoryType)[]> {\n\n        const ops = this._objectPaths.copy().appendActionToLast(opQuery([], this.getSelects()));\n\n        return this.send<DataType[]>(ops).then(r => r.map(d => extend(factory(d), d)));\n    }\n\n    /**\n     * Invokes the specified method on the server and returns the result\n     * \n     * @param methodName Name of the method to invoke\n     * @param params Method parameters\n     * @param actions Any additional actions to execute in addition to the method invocation (set property for example)\n     */\n    protected invokeMethod<T>(methodName: string, params: IMethodParamsBuilder | null = null, ...actions: string[]): Promise<T> {\n        return this.invokeMethodImpl(methodName, params, actions, opQuery([], null));\n    }\n\n    /**\n     * Invokes a method action that returns a single result and does not have an associated query (ex: GetDescription on Term)\n     * \n     * @param methodName Name of the method to invoke\n     * @param params Method parameters\n     * @param actions Any additional actions to execute in addition to the method invocation (set property for example)\n     */\n    protected invokeMethodAction<T>(methodName: string, params: IMethodParamsBuilder | null = null, ...actions: string[]): Promise<T> {\n        return this.invokeMethodImpl(methodName, params, actions, null, true);\n    }\n\n    /**\n     * Invokes the specified non-query method on the server\n     * \n     * @param methodName Name of the method to invoke\n     * @param params Method parameters\n     * @param actions Any additional actions to execute in addition to the method invocation (set property for example)\n     */\n    protected invokeNonQuery(methodName: string, params: IMethodParamsBuilder | null = null, ...actions: string[]): Promise<void> {\n        // by definition we are not returning anything from these calls so we should not be caching the results\n        this._useCaching = false;\n        return this.invokeMethodImpl<void>(methodName, params, actions, null, true);\n    }\n\n    /**\n     * Invokes the specified method on the server and returns the resulting collection\n     * \n     * @param methodName Name of the method to invoke\n     * @param params Method parameters\n     * @param actions Any additional actions to execute in addition to the method invocation (set property for example)\n     */\n    protected invokeMethodCollection<T>(methodName: string, params: IMethodParamsBuilder | null = null, ...actions: string[]): Promise<T> {\n        return this.invokeMethodImpl(methodName, params, actions, opQuery([], []));\n    }\n\n    /**\n     * Updates this instance, returning a copy merged with the updated data after the update\n     * \n     * @param properties Plain object of the properties and values to update\n     * @param factory Factory method use to create a new instance of FactoryType\n     */\n    protected invokeUpdate<DataType, FactoryType>(properties: any, factory: ClientSvcQueryableConstructor<FactoryType>): Promise<DataType & FactoryType> {\n\n        const ops = this._objectPaths.copy();\n        // append setting all the properties to this instance\n        objectProperties(properties).map(a => ops.appendActionToLast(a));\n        ops.appendActionToLast(opQuery([], null));\n        return this.send<DataType>(ops).then(r => extend(new factory(this), r));\n    }\n\n    /**\n     * Converts the current instance to a request context\n     *\n     * @param verb The request verb\n     * @param options The set of supplied request options\n     * @param parser The supplied ODataParser instance\n     * @param pipeline Optional request processing pipeline\n     */\n    protected toRequestContext<T>(\n        verb: string,\n        options: FetchOptions,\n        parser: ODataParser<T>,\n        pipeline: Array<(c: RequestContext<T>) => Promise<RequestContext<T>>>): Promise<RequestContext<T>> {\n\n        return toAbsoluteUrl(this.toUrlAndQuery()).then(url => {\n\n            mergeOptions(options, this._options);\n\n            const headers = new Headers();\n\n            mergeHeaders(headers, options.headers);\n\n            mergeHeaders(headers, {\n                \"accept\": \"*/*\",\n                \"content-type\": \"text/xml\",\n            });\n\n            options = extend(options, { headers });\n\n            // we need to do some special cache handling to ensure we have a good key\n            if (this._useCaching) {\n\n                let keyStr = options.body;\n\n                if (stringIsNullOrEmpty(keyStr)) {\n\n                    if (hOP(options, \"clientsvc_ObjectPaths\")) {\n                        // if we are using caching and batching together we need to create our string from the paths stored for the\n                        // batching operation (see: https://github.com/pnp/pnpjs/issues/449) but not update the ones passed to\n                        // the batch as they will be indexed during the batch creation process\n                        keyStr = (<{ clientsvc_ObjectPaths: ObjectPathQueue }>options).clientsvc_ObjectPaths.clone().toBody();\n                    } else {\n                        // this case shouldn't happen\n                        keyStr = \"\";\n                    }\n                }\n\n                // because all the requests use the same url they would collide in the cache we use a special key\n                const cacheKey = `PnPjs.ProcessQueryClient(${getHashCode(keyStr)})`;\n\n                if (objectDefinedNotNull(this._cachingOptions)) {\n                    // if our key ends in the ProcessQuery url we overwrite it\n                    if (/\\/client\\.svc\\/ProcessQuery\\?$/i.test(this._cachingOptions.key)) {\n                        this._cachingOptions.key = cacheKey;\n                    }\n                } else {\n                    this._cachingOptions = new CachingOptions(cacheKey);\n                }\n            }\n\n            const dependencyDispose = this.hasBatch ? this._batchDependency : () => { return; };\n\n            // build our request context\n            const context: RequestContext<T> = {\n                batch: this.batch,\n                batchDependency: dependencyDispose,\n                cachingOptions: this._cachingOptions,\n                clientFactory: () => new SPHttpClient(),\n                isBatched: this.hasBatch,\n                isCached: this._useCaching,\n                options: options,\n                parser: parser,\n                pipeline: pipeline,\n                requestAbsoluteUrl: url,\n                requestId: getGUID(),\n                verb: verb,\n            };\n\n            return context;\n        });\n    }\n\n    /**\n     * Blocks a batch call from occuring, MUST be cleared by calling the returned function\n    */\n    protected addBatchDependency(): () => void {\n        if (this._batch !== null) {\n            return this._batch.addDependency();\n        }\n\n        return () => null;\n    }\n\n    /**\n     * Indicates if the current query has a batch associated\n     *\n     */\n    protected get hasBatch(): boolean {\n        return objectDefinedNotNull(this._batch);\n    }\n\n    /**\n     * The batch currently associated with this query or null\n     *\n     */\n    protected get batch(): IObjectPathBatch {\n        return this.hasBatch ? this._batch : null;\n    }\n\n    /**\n     * Executes the actual invoke method call\n     * \n     * @param methodName Name of the method to invoke\n     * @param params Method parameters\n     * @param queryAction Specifies the query action to take\n     */\n    private invokeMethodImpl<T>(methodName: string, params: IMethodParamsBuilder | null, actions: string[], queryAction: string, isAction = false): Promise<T> {\n\n        const ops = this._objectPaths.copy();\n\n        if (isAction) {\n            ops.appendActionToLast(methodAction(methodName, params));\n        } else {\n            ops.add(method(methodName, params, ...[objectPath(), ...actions, queryAction]));\n        }\n\n        return this.send<T>(ops);\n    }\n}\n","import { LogLevel, Logger } from \"@pnp/logging\";\nimport { CachingParserWrapper, ODataBatch, ODataBatchRequestInfo } from \"@pnp/odata\";\nimport { ClientSvcQueryable } from \"./clintsvcqueryable\";\nimport { ObjectPath, ObjectPathQueue, opSetId, opSetParentId, opSetPathId, opSetPathParamId } from \"./objectpath\";\nimport { objectPath } from \"./opactionbuilders\";\nimport { staticMethod } from \"./opbuilders\";\nimport { ProcessQueryParser } from \"./parsers\";\nimport { writeObjectPathBody } from \"./utils\";\n\nexport interface IObjectPathBatch extends ODataBatch {\n\n}\n\n/**\n * Implements ODataBatch for use with the ObjectPath framework\n */\nexport class ObjectPathBatch extends ODataBatch implements IObjectPathBatch {\n\n    constructor(protected parentUrl: string, _batchId?: string) {\n        super(_batchId);\n    }\n\n    protected executeImpl(): Promise<void> {\n\n        // if we don't have any requests, don't bother sending anything\n        // this could be due to caching further upstream, or just an empty batch\n        if (this.requests.length < 1) {\n            Logger.write(`Resolving empty batch.`, LogLevel.Info);\n            return Promise.resolve();\n        }\n\n        const executor = new BatchExecutor(this.parentUrl, this.batchId);\n        executor.appendRequests(this.requests);\n        return executor.execute();\n    }\n}\n\nclass BatchExecutor extends ClientSvcQueryable {\n\n    private _builderIndex: number;\n    private _requests: ODataBatchRequestInfo[];\n\n    constructor(parentUrl: string, public batchId: string) {\n        super(parentUrl);\n\n        this._requests = [];\n        this._builderIndex = 1;\n\n        // we add our session object path and hard code in the IDs so we can reference it\n        const method = staticMethod(\"GetTaxonomySession\", \"{981cbc68-9edc-4f8d-872f-71146fcbb84f}\");\n        method.path = opSetId(\"0\", method.path);\n        method.actions.push(opSetId(\"1\", opSetPathId(\"0\", objectPath())));\n\n        this._objectPaths.add(method);\n    }\n\n    public appendRequests(requests: ODataBatchRequestInfo[]): void {\n\n        requests.forEach(request => {\n\n            // grab the special property we added to options when we created the batch info\n            const pathQueue: ObjectPathQueue = (<any>request.options).clientsvc_ObjectPaths;\n\n            let paths = pathQueue.toArray();\n\n            // getChildRelationships\n            if (paths.length < 0) {\n                return;\n            }\n\n            let indexMappingFunction = (n: number) => n;\n\n            if (/GetTaxonomySession/i.test(paths[0].path)) {\n\n                // drop the first thing as it is a get session object path, which we add once for the entire batch\n                paths = paths.slice(1);\n\n                // replace the next item's parent id with 0, which will be the id of the session call at the root of this request\n                paths[0].path = opSetParentId(\"0\", paths[0].path);\n\n                indexMappingFunction = (n: number) => n - 1;\n            }\n\n            let lastOpId = -1;\n            const idIndexMap: number[] = [];\n\n            paths.map((op, index, arr) => {\n\n                // rewrite the path string\n                const opId = ++this._builderIndex;\n\n                // track the array index => opId relationship\n                idIndexMap.push(opId);\n\n                let path = opSetPathParamId(idIndexMap, opSetId(opId.toString(), op.path), indexMappingFunction);\n                if (lastOpId >= 0) {\n                    path = opSetParentId(lastOpId.toString(), path);\n                }\n\n                // rewrite actions with placeholders replaced\n                const opActions = op.actions.map(a => {\n                    const actionId = ++this._builderIndex;\n                    return opSetId(actionId.toString(), opSetPathId(opId.toString(), a));\n                });\n\n                // handle any specific child relationships\n                // the childIndex is reduced by 1 because we are removing the Session Path\n                pathQueue.getChildRelationship(index + 1).map(i => i - 1).forEach(childIndex => {\n                    // set the parent id for our non-immediate children\n                    arr[childIndex].path = opSetParentId(opId.toString(), arr[childIndex].path);\n                });\n\n                // and remember our last object path id for the parent replace above\n                lastOpId = opId;\n\n                // return our now substituted path and actions as a new object path instance\n                return new ObjectPath(path, opActions);\n\n            }).forEach(op => this._objectPaths.add(op));\n\n            // get this once\n            const obPaths = this._objectPaths.toArray();\n\n            // create a new parser to handle finding the result based on the path\n            const parser = new ProcessQueryParser(obPaths[obPaths.length - 1]);\n\n            if (request.parser instanceof CachingParserWrapper) {\n                // handle special case of caching\n                request.parser = new ProcessQueryCachingParserWrapper(parser, request.parser);\n            } else {\n                request.parser = parser;\n            }\n\n            // add the request to our batch requests\n            this._requests.push(request);\n\n            // remove the temp property\n            delete (<any>request.options).clientsvc_ObjectPaths;\n        });\n    }\n\n    public execute(): Promise<void> {\n\n        Logger.write(`[${this.batchId}] (${(new Date()).getTime()}) Executing batch with ${this._requests.length} requests.`, LogLevel.Info);\n\n        // create our request body from all the merged object paths\n        const options = {\n            body: writeObjectPathBody(this._objectPaths.toArray()),\n        };\n\n        Logger.write(`[${this.batchId}] (${(new Date()).getTime()}) Sending batch request.`, LogLevel.Info);\n\n        // send the batch\n        return super.postCore(options, new BatchParser()).then((rawResponse: any) => {\n\n            Logger.write(`[${this.batchId}] (${(new Date()).getTime()}) Resolving batched requests.`, LogLevel.Info);\n\n            return this._requests.reduce((chain, request) => {\n\n                Logger.write(`[${request.id}] (${(new Date()).getTime()}) Resolving request in batch ${this.batchId}.`, LogLevel.Info);\n\n                return chain.then(_ => (<ProcessQueryParser>request.parser).findResult(rawResponse).then(request.resolve).catch(request.reject));\n\n            }, Promise.resolve());\n        });\n    }\n}\n\n/**\n * Used to return the raw results from parsing the batch\n */\nclass BatchParser<T = any> extends ProcessQueryParser<T> {\n\n    constructor() {\n        super(null);\n    }\n\n    public findResult(json: any): Promise<T> {\n        // we leave it to the individual request parsers to find their results in the raw json body\n        return json;\n    }\n}\n\n/**\n * Handles processing batched results that are also cached\n */\nclass ProcessQueryCachingParserWrapper<T> extends CachingParserWrapper<T> {\n\n    constructor(parser: ProcessQueryParser, wrapper: CachingParserWrapper<T>) {\n        super(parser, wrapper.cacheOptions);\n    }\n\n    public findResult(json: any): Promise<T> {\n        return (<any>this.parser).findResult(json).then((d: any) => this.cacheData(d));\n    }\n}\n"],"names":["method"],"mappings":"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"}